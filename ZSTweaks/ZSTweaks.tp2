BACKUP "weidu_external/backup/ZSTweaks"
AUTHOR "RoyalProtector at Gibberlings's forum https://www.gibberlings3.net/profile/12720-royalprotector/"
VERSION "v1.0"
README ~ZSTweaks/README.md~
AUTO_EVAL_STRINGS
/////////////////////////////////////////////////////////////////////////////////////////////////////
LANGUAGE
"English"
"english"
"ZSTweaks/lang/english/setup.tra"

////////////////// SPELL TWEAKS \\\\\\\\\\\\\\\\\\\\\\\\\\

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @100 DESIGNATED 100 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPPR304.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5000
    SAY DESC @5000
    LPF ALTER_EFFECT
        INT_VAR
            match_savingthrow = 2**0 + 2**24
            special = 256
    END
    SET new_header = (SHORT_AT 0x68) + 1
    FOR ( level = 19; level <= 20; ++level ) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = new_header - 1
                zs_min_level_for_copy = level
        END
        LPF ALTER_SPELL_EFFECT
            INT_VAR
                header = new_header
                match_opcode = 12
                dicenumber = level
        END
        ++new_header
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @110 DESIGNATED 110 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPPR101.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5010
    SAY DESC @5010
    SET headers = 0
    FOR (i = 3; i <= 19; i += 2) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = i
        END
        headers += 1
    END
    SET dur = 42
    FOR (i = 1; i <= headers; i+=1) BEGIN
        LPF ALTER_EFFECT
            INT_VAR
                header = i
                match_duration = 36
                duration = dur
        END
        dur += 6
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @120 DESIGNATED 120 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~FBLADE.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY

COPY_EXISTING ~SHILLE.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY

COPY_EXISTING ~PHANBLAD.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY

COPY_EXISTING ~BLAKBLAD.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY

COPY_EXISTING ~SHAMMR.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY

COPY_EXISTING ~SHAMMR2.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY

COPY_EXISTING ~SHAMMR3.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 1
            def_parameter2 = 0
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=1~
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @130 DESIGNATED 130 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR208.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5020
    SAY DESC @5020
    LPF ALTER_EFFECT
        INT_VAR
            match_savingthrow = 1
            savebonus = "-1"
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
 BEGIN @140 DESIGNATED 140 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPWI713.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5030
    SAY DESC @5030
    LPF ALTER_EFFECT
        INT_VAR
            header = 0
            match_opcode = 12
            parameter1 = 14
    END

    SET headers = 0
    FOR (i = 15; i <= 20; i+=1) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = i
        END
        headers += 1
    END

    SET damage = 15
    FOR (i = 1; i <= headers; i+=1) BEGIN
        LPF ALTER_EFFECT
            INT_VAR
                header = i
                match_opcode = 12
                parameter1 = damage
        END
        damage += 1
    END

BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
//BEGIN @150 DESIGNATED 150 GROUP @1 Left alone for now
/////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @160 DESIGNATED 160 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~BLAKBLAD.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // Self
            def_timing = 2
            def_parameter1 = 0
            def_parameter2 = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes  = ~op=263~
    END
BUT_ONLY

ACTION_IF GAME_IS "bg2ee eet" BEGIN
    COPY_EXISTING ~CDGOLIRO.ITM~ ~override~
        LPF a7_auto_apply_spl_effect
            INT_VAR
                def_target = 1  // Self
                def_timing = 2
                def_parameter1 = 0
                def_parameter2 = 1
            STR_VAR
                function_name = ~ADD_ITEM_EQEFFECT~
                effect_codes  = ~op=263~
        END
    BUT_ONLY
END

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @170 DESIGNATED 170 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SPWI913.SPL~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 2  // Preset target
            def_power = 9
        STR_VAR
            function_name = ~ADD_SPELL_EFFECT~
            effect_codes  = ~op=12,p1=3,tmg=1,dr=1,dnum=3,dsize=6,p2=0;op=80,tmg=0,rd=2,dur=12~
    END

    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 12
            parameter2 = (64 << 16)
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @180 DESIGNATED 180 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPWI911.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5040
    SAY DESC @5040
    LPF ALTER_EFFECT
        INT_VAR
            header = 0
            match_opcode = 12
            parameter1 = 14
            dicenumber = 2
            dicesize = 10
    END

    SET headers = 0
    FOR (i = 15; i <= 20; i+=1) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = i
        END
        headers += 1
    END

    SET damage = 15
    FOR (i = 1; i <= headers; i+=1) BEGIN
        LPF ALTER_EFFECT
            INT_VAR
                header = i
                match_opcode = 12
                parameter1 = damage
        END
        damage += 1
    END


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @190 DESIGNATED 190 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPPR412.SPL~ ~override~
    LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = 13
            zs_min_level_for_copy = 21
    END

    LPF ALTER_EFFECT
        INT_VAR
            header = 14
            match_opcode = 54
            parameter1 = 0
    END
BUT_ONLY

COPY_EXISTING ~SPWI603.SPL~ ~override~
    LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = 8
            zs_min_level_for_copy = 21
    END

    LPF ALTER_EFFECT
        INT_VAR
            header = 9
            multi_match = 1
            match_opcode = 54
            parameter1 = 0
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
//BEGIN @200 DESIGNATED 200 GROUP @1 For later, no implementation for now
/////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @210 DESIGNATED 210 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPWI205.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5050
    WRITE_ASCII 0x10 ~CAS_M05~ #8
    WRITE_BYTE 0x22 11
    WRITE_BYTE 0x25 4
    WRITE_SHORT 0x1e (2**11) // this wipes out the whole bitfield and sets it to 2048 (evocation)
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @220 DESIGNATED 220 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPWI404.SPL~ ~override~
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 12
            parameter1 = 0
            dicenumber = 3
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
//BEGIN @230 DESIGNATED 230 GROUP @1 for later
/////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @240 DESIGNATED 240 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////
// TODO: should probably add a regen portrait icon...
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SPPR207.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5060
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 122
            parameter1 = 6
    END
BUT_ONLY
COPY_EXISTING ~GBERRY.ITM~ ~override~
    SAY DESC @5070
    WRITE_BYTE 0x38 12
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            match_headers = 1
            match_opcode = 17
            duration = 0
            parameter1 = 0
            dicesize = 4
            dicenumber = 2
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1  // self
            def_power = 2
            def_timing = 1 // instant limited
            def_parameter1 = 60 // turn
            def_parameter2 = 3 // 1HP per <param1>
            def_duration = 2700
            def_resist_dispel = 2
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes  = ~op=98;op=142,p1=0,p2=87~ // regen and portrait icon for regen
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @250 DESIGNATED 250 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR720.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5090
    LPF ALTER_SPELL_HEADER
        INT_VAR
            projectile = 159 // same area of effect but party friendly quake
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @260 DESIGNATED 260 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPPR413.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5080
    SAY DESC @5080
    SET headers = 0
    FOR (i = 9; i <= 19; i += 2) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = i
        END
        headers += 1
    END
    SET dur = 36
    FOR (i = 1; i <= headers; i += 1) BEGIN
        LPF ALTER_EFFECT
            INT_VAR
                header = i
                match_duration = 30
                duration = dur
        END
        dur += 6
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @270 DESIGNATED 270 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPPR105.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5100
    LPF ALTER_EFFECT
        INT_VAR
            savebonus = 2
    END

    SET headers = 0
    FOR (i = 5; i <= 20; i += 5) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = i
        END
        headers += 1
    END

    SET bonus = 1
    FOR (i = 1; i <= headers; i += 1) BEGIN
        LPF ALTER_EFFECT
            INT_VAR
                header = i
                savebonus = bonus
        END
        bonus -= 1
    END

BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @280 DESIGNATED 280 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR411.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5110
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 12
            special = 256
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @290 DESIGNATED 290 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR412.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5120
    SET dur = 42

    FOR (i = 1; i <= 6; i += 1) BEGIN
        LPF ADD_SPELL_EFFECT
            INT_VAR
                opcode = 1
                header = i
                duration = dur
                power = 4
                target = 1
                resist_dispel = 3
                parameter1 = 6
        END
        dur += 6
    END

    READ_SHORT 0x68 num_abilities

    FOR (i = 7; i <= num_abilities; i += 1) BEGIN
        LPF ADD_SPELL_EFFECT
            INT_VAR
                opcode = 1
                header = i
                duration = dur
                power = 4
                target = 1
                resist_dispel = 3
                parameter1 = 1
        END
        dur += 6
    END

BUT_ONLY

COPY_EXISTING ~SPWI603.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5130
    SET dur = 72
    LPF ADD_SPELL_EFFECT
        INT_VAR
            opcode = 1
            header = 1
            duration = dur
            power = 6
            target = 1
            resist_dispel = 3
            parameter1 = 6
    END

    dur = 78
    READ_SHORT 0x68 num_abilities
    FOR (i = 2; i <= num_abilities; i += 1) BEGIN
        LPF ADD_SPELL_EFFECT
            INT_VAR
                opcode = 1
                header = i
                duration = dur
                power = 6
                target = 1
                resist_dispel = 3
                parameter1 = 1
            END
        dur += 6
    END

BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @300 DESIGNATED 300 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR506.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5140
    LPF ALTER_SPELL_HEADER
        INT_VAR
            speed = 1
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @310 DESIGNATED 310 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR606.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5150
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 122
            parameter1 = 12
    END
BUT_ONLY
COPY_EXISTING ~FIRESEED.ITM~ ~override~
    SAY UNIDENTIFIED_DESC @5160
    WRITE_BYTE 0x60 2
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 12
            parameter1 = 5
            dicesize = 8
            dicenumber = 3
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @320 DESIGNATED 320 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR704.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5170
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 55
            savebonus = 1
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @330 DESIGNATED 330 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR709.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5180
    LPF ALTER_EFFECT
        INT_VAR
            match_savebonus = "-2"
            savebonus = "-4"
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @340 DESIGNATED 340 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SPPR719.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5190
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_insertpoint = 0
        STR_VAR
            function_name = ~ADD_SPELL_EFFECT~
            effect_codes = ~op=55,tgt=2,p2=2,tmg=1,rd=1,stype=4,sbonus=6~
    END
BUT_ONLY

COPY_EXISTING ~SPWI817.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5200
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_insertpoint = 0
        STR_VAR
            function_name = ~ADD_SPELL_EFFECT~
            effect_codes = ~op=55,tgt=2,p2=2,tmg=1,rd=1,stype=4,sbonus=6~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @350 DESIGNATED 350 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR720.SPL~ ~override~
    LPF DELETE_SPELL_EFFECT
        INT_VAR opcode_to_delete = 269
    END
    LPF DELETE_EFFECT
        STR_VAR match_resource = ~SHAKE1~
    END
BUT_ONLY

ACTION_IF !GAME_IS "bgee" BEGIN
    COPY_EXISTING ~SPOGRE01.SPL~ ~override~
        LPF DELETE_SPELL_EFFECT
            INT_VAR opcode_to_delete = 269
        END
        LPF DELETE_EFFECT
            STR_VAR match_resource = ~SHAKE1~
        END
    BUT_ONLY
END


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @360 DESIGNATED 360 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR751.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5210
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            match_opcode = 12
            dicesize = 6
            dicenumber = 6
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @370 DESIGNATED 370 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPWI221.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5220
    WRITE_ASCII 0x10 ~CAS_M07~ #8
    WRITE_BYTE 0x22 9
    WRITE_BYTE 0x25 7
    WRITE_SHORT 0x1e (2**10) // this wipes out the whole bitfield and sets it to illusion
    READ_SHORT 0x68 num_abilities
    FOR (i = 1; i <= num_abilities; i += 1) BEGIN
        LPF ALTER_SPELL_HEADER
            INT_VAR
                projectile = 50 // necromancy projectile
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @380 DESIGNATED 380 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////
// contagion
COPY_EXISTING ~SPWI409.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5240
    LPF DELETE_EFFECT
        INT_VAR
            match_opcode = 78
            match_parameter2 = 9
    END
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 78
            match_parameter2 = 4
            parameter1 = 4
    END
    LPF ALTER_EFFECT
        INT_VAR
            match_opcode = 78
            match_parameter2 = 5
            parameter1 = 4
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @390 DESIGNATED 390 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPWI614.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5230
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            match_opcode = 12
            dicesize = 4
            dicenumber = 4
            parameter1 = 0
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @400 DESIGNATED 400 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
//////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPWI914.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @5250
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            match_opcode = 216
            parameter1 = 6
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @410 DESIGNATED 410 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BG2EE or EET"
//////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
COPY
     ~ZSTweaks/eff/ZSTWHW16.EFF~ ~override~
     ~ZSTweaks/eff/ZSTWHW17.EFF~ ~override~
     ~ZSTweaks/eff/ZSTWHW18.EFF~ ~override~
     ~ZSTweaks/eff/ZSTWHW19.EFF~ ~override~
     ~ZSTweaks/eff/ZSTWHW20.EFF~ ~override~

COPY_EXISTING ~ohbwat01.CRE~ ~override~ // make sure existing water elementals are considered water elementals as per the class
    WRITE_BYTE 0x273 "-37" // ELEMENTAL_WATER
BUT_ONLY

COPY_EXISTING ~ELWATG01.CRE~ ~override~ // make sure existing water elementals are considered water elementals as per the class
    WRITE_BYTE 0x273 "-37" // ELEMENTAL_WATER
BUT_ONLY

COPY_EXISTING ~SPWI812.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @6210
    LPF ADD_SPELL_EFFECT // immunity for undead and golems
        INT_VAR
            insert_point = 0
            header = 1
            target = 2
            opcode = 324
            power = 8
            parameter2 = 55
            timing = 1
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 1
            header = 1
            target = 2
            opcode = 177
            power = 8
            parameter1 = 219
            parameter2 = 5
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW16.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 2
            header = 1
            target = 2
            opcode = 177
            power = 8
            parameter1 = 164
            parameter2 = 4
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW16.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 3
            header = 1
            target = 2
            opcode = 177
            power = 8
            parameter1 = 7
            parameter2 = 3
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW16.EFF~
    END
    LPF ADD_SPELL_EFFECT // immunity for elemental water
        INT_VAR
            insert_point = 4
            header = 1
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 219
            parameter2 = 105
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for myconids
        INT_VAR
            insert_point = 5
            header = 1
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter2 = 11
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for plants
        INT_VAR
            insert_point = 6
            header = 1
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 7
            parameter2 = 103
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END

    LPF ADD_SPELL_EFFECT // immunity for undead and golems
        INT_VAR
            insert_point = 0
            header = 2
            target = 2
            opcode = 324
            power = 8
            parameter2 = 55
            timing = 1
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 1
            header = 2
            target = 2
            opcode = 177
            power = 8
            parameter1 = 219
            parameter2 = 5
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW17.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 2
            header = 2
            target = 2
            opcode = 177
            power = 8
            parameter1 = 164
            parameter2 = 4
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW17.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 3
            header = 2
            target = 2
            opcode = 177
            power = 8
            parameter1 = 7
            parameter2 = 3
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW17.EFF~
    END
    LPF ADD_SPELL_EFFECT // immunity for elemental water
        INT_VAR
            insert_point = 4
            header = 2
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 219
            parameter2 = 105
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for myconids
        INT_VAR
            insert_point = 5
            header = 2
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter2 = 11
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for plants
        INT_VAR
            insert_point = 6
            header = 2
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 7
            parameter2 = 103
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END

    LPF ADD_SPELL_EFFECT // immunity for undead and golems
        INT_VAR
            insert_point = 0
            header = 3
            target = 2
            opcode = 324
            power = 8
            parameter2 = 55
            timing = 1
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 1
            header = 3
            target = 2
            opcode = 177
            power = 8
            parameter1 = 219
            parameter2 = 5
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW18.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 2
            header = 3
            target = 2
            opcode = 177
            power = 8
            parameter1 = 164
            parameter2 = 4
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW18.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 3
            header = 3
            target = 2
            opcode = 177
            power = 8
            parameter1 = 7
            parameter2 = 3
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW18.EFF~
    END
    LPF ADD_SPELL_EFFECT // immunity for elemental water
        INT_VAR
            insert_point = 4
            header = 3
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 219
            parameter2 = 105
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for myconids
        INT_VAR
            insert_point = 5
            header = 3
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter2 = 11
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for plants
        INT_VAR
            insert_point = 6
            header = 3
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 7
            parameter2 = 103
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END

    LPF ADD_SPELL_EFFECT // immunity for undead and golems
        INT_VAR
            insert_point = 0
            header = 4
            target = 2
            opcode = 324
            power = 8
            parameter2 = 55
            timing = 1
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 1
            header = 4
            target = 2
            opcode = 177
            power = 8
            parameter1 = 219
            parameter2 = 5
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW19.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 2
            header = 4
            target = 2
            opcode = 177
            power = 8
            parameter1 = 164
            parameter2 = 4
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW19.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 3
            header = 4
            target = 2
            opcode = 177
            power = 8
            parameter1 = 7
            parameter2 = 3
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW19.EFF~
    END
    LPF ADD_SPELL_EFFECT // immunity for elemental water
        INT_VAR
            insert_point = 4
            header = 4
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 219
            parameter2 = 105
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for myconids
        INT_VAR
            insert_point = 5
            header = 4
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter2 = 11
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for plants
        INT_VAR
            insert_point = 6
            header = 4
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 7
            parameter2 = 103
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END

    LPF ADD_SPELL_EFFECT // immunity for undead and golems
        INT_VAR
            insert_point = 0
            header = 5
            target = 2
            opcode = 324
            power = 8
            parameter2 = 55
            timing = 1
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 1
            header = 5
            target = 2
            opcode = 177
            power = 8
            parameter1 = 219
            parameter2 = 5
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW20.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 2
            header = 5
            target = 2
            opcode = 177
            power = 8
            parameter1 = 164
            parameter2 = 4
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW20.EFF~
    END
    LPF ADD_SPELL_EFFECT // damage for water elementals
        INT_VAR
            insert_point = 3
            header = 5
            target = 2
            opcode = 177
            power = 8
            parameter1 = 7
            parameter2 = 3
            timing = 1
            resist_dispel = 1
            save_bonus = 16777216 // bypass mirror image
        STR_VAR
            resource = ~ZSTWHW20.EFF~
    END
    LPF ADD_SPELL_EFFECT // immunity for elemental water
        INT_VAR
            insert_point = 4
            header = 5
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 219
            parameter2 = 105
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for myconids
        INT_VAR
            insert_point = 5
            header = 5
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter2 = 11
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END
    LPF ADD_SPELL_EFFECT // immunity for plants
        INT_VAR
            insert_point = 6
            header = 5
            target = 2
            opcode = 324
            power = 8
            timing = 1
            parameter1 = 7
            parameter2 = 103
            resist_dispel = 1
        STR_VAR
            resource = ~SPWI812~
    END

BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @420 DESIGNATED 420 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
//////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SPPR111.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @6200
    READ_SHORT 0x68 num_abilities
    SET start_dur = 24
    FOR ( i = 0; i < num_abilities; ++i ) BEGIN
        SET dur = start_dur + (i * 6)
        LPF ADD_SPELL_EFFECT
            INT_VAR
                header = i + 1
                target = 1
                opcode = 0
                parameter1 = 2
                power = 1
                duration = dur
                resist_dispel = 3
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @430 DESIGNATED 430 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE, BG2EE and EET"
//////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SPWI101.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @6190
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header_type = 1
            check_headers = 1
            resist_dispel = 0
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            match_opcode = 126
            header_type = 1
            check_headers = 1
            parameter1 = 27
    END
    READ_SHORT 0x68 num_abilities
    SET start_dur = 24
    FOR ( i = 0; i < num_abilities; ++i ) BEGIN
        SET dur = start_dur + (i * 6)
        LPF ADD_SPELL_EFFECT
            INT_VAR
                header = i + 1
                target = 2
                opcode = 30
                parameter1 = "-25"
                power = 1
                duration = dur
                resist_dispel = 0
        END
        LPF ADD_SPELL_EFFECT
            INT_VAR
                header = i + 1
                target = 2
                opcode = 126
                parameter1 = 75
                parameter2 = 5
                power = 1
                duration = dur
                resist_dispel = 0
        END
    END
BUT_ONLY


/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @440 DESIGNATED 440 GROUP @1
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
//////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SPWI925.SPL~ ~override~
    SAY IDENTIFIED_DESC @6430
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            check_headers = 1
            resist_dispel = 0 // natural / non magical
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 12
            parameter1 = 10
            dicenumber = 2
    END
    SET cold = (2 << 16)
    LPF ADD_SPELL_EFFECT // crushing
        INT_VAR
            insert_point = 0
            target = 2
            opcode = 12
            dicesize = 10
            dicenumber = 3
            parameter1 = 10
            timing = 1
            power = 9
            savingthrow = 16777216 // bypass mirror image (only EE)
    END
    LPF ADD_SPELL_EFFECT
        INT_VAR
            insert_point = 0
            target = 2
            opcode = 12
            dicesize = 10
            dicenumber = 2
            parameter1 = 10
            parameter2 = cold
            timing = 1
            power = 9
            savingthrow = 16777216 // bypass mirror image (only EE)
    END
BUT_ONLY

/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @450 DESIGNATED 450 GROUP @1
REQUIRE_PREDICATE GAME_IS "iwdee bgee bg2ee eet" "This component is available for IWDEE, BGEE, BG2EE and EET"
//////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPPR103.SPL~ ~override~
    PATCH_IF GAME_IS "iwdee" BEGIN
        SAY UNIDENTIFIED_DESC @6471
    END ELSE BEGIN
        SAY UNIDENTIFIED_DESC @6470
    END
    SET base_heal = 9
    FOR ( number = 1; number <= 4; ++number ) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = number + 1
        END
        LPF ALTER_SPELL_EFFECT
            INT_VAR
                header = number + 1
                match_opcode = 17
                parameter1 = base_heal
        END
        ++base_heal
    END
BUT_ONLY

ACTION_IF FILE_EXISTS ~SPPR217.SPL~ BEGIN
    COPY_EXISTING ~SPPR103.SPL~ ~override~
        SAY UNIDENTIFIED_DESC @6473
        SET base_heal = 13
        LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 1
            match_opcode = 17
            parameter1 = base_heal
        END
        base_heal += 2
        SET current_header = 2
        FOR ( number = 4; number < 8; ++number ) BEGIN
            SET heal_jump = 1
            PATCH_IF number <= 5 BEGIN
                SET heal_jump = 2
            END
            LPF ADD_SPELL_HEADER
                INT_VAR
                    copy_header = 1
                    zs_min_level_for_copy = number + 1
            END
            LPF ALTER_SPELL_EFFECT
                INT_VAR
                    header = current_header
                    match_opcode = 17
                    parameter1 = base_heal
            END
            base_heal += jump
            ++current_header
        END
    BUT_ONLY
END

COPY_EXISTING ~SPPR315.SPL~ ~override~
    PATCH_IF GAME_IS "iwdee" BEGIN
        SAY UNIDENTIFIED_DESC @6474
    END ELSE BEGIN
        SAY UNIDENTIFIED_DESC @6473
    END
    SET base_heal = 20
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 1
            match_opcode = 17
            parameter1 = base_heal
    END
    base_heal += 2
    SET current_header = 2
    FOR ( number = 6; number < 10; ++number ) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = number
        END
        LPF ALTER_SPELL_EFFECT
            INT_VAR
                header = current_header
                match_opcode = 17
                parameter1 = base_heal
        END
        base_heal+=2
        ++current_header
    END
BUT_ONLY

COPY_EXISTING ~SPPR401.SPL~ ~override~
    PATCH_IF GAME_IS "iwdee" BEGIN
        SAY UNIDENTIFIED_DESC @6476
    END ELSE BEGIN
        SAY UNIDENTIFIED_DESC @6475
    END
    SET base_heal = 30
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 1
            match_opcode = 17
            parameter1 = base_heal
    END
    base_heal += 3
    SET current_header = 2
    FOR ( number = 8; number < 12; ++number ) BEGIN
        SET heal_jump = 2
        PATCH_IF number <= 10 BEGIN
            SET heal_jump = 3
        END
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = number
        END
        LPF ALTER_SPELL_EFFECT
            INT_VAR
                header = current_header
                match_opcode = 17
                parameter1 = base_heal
        END
        base_heal+=heal_jump
        ++current_header
    END
BUT_ONLY

COPY_EXISTING ~SPPR502.SPL~ ~override~
    PATCH_IF GAME_IS "iwdee" BEGIN
        SAY UNIDENTIFIED_DESC @6478
    END ELSE BEGIN
        SAY UNIDENTIFIED_DESC @6477
    END
    SET base_heal = 42
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 1
            match_opcode = 17
            parameter1 = base_heal
    END
    base_heal += 3
    SET current_header = 2
    FOR ( number = 10; number < 14; ++number ) BEGIN
        LPF ADD_SPELL_HEADER
            INT_VAR
                copy_header = 1
                zs_min_level_for_copy = number
        END
        LPF ALTER_SPELL_EFFECT
            INT_VAR
                header = current_header
                match_opcode = 17
                parameter1 = base_heal
        END
        base_heal+=3
        ++current_header
    END
BUT_ONLY

/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @460 DESIGNATED 460 GROUP @1
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BG2EE and EET"
//////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING ~SPPR514.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @6480
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            match_opcode = 17
            dicenumber = 4
            dicesize = 3
    END
    LPF ALTER_HEADER
        INT_VAR
            type = 1
            speed = 2
    END
BUT_ONLY

////////////////// ITEM TWEAKS \\\\\\\\\\\\\\\\\\\\\\\\\\

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1000 DESIGNATED 1000 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "DAGG16.itm" ~override~
    SAY UNIDENTIFIED_DESC @6380
    LPF ALTER_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 2
            match_opcode = 25
            savebonus = "-2"
    END
    LPF ALTER_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 2
            match_opcode = 142
            savebonus = "-2"
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1010 DESIGNATED 1010 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "DART05.itm" ~override~
    SAY IDENTIFIED_DESC @6390
    LPF ALTER_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 2
            match_opcode = 25
            savebonus = "-4"
    END
    LPF ALTER_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 2
            match_opcode = 142
            savebonus = "-4"
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1120 DESIGNATED 1120 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
INCLUDE ~ZSTweaks/libs/zs_correct_animations.tph~

COPY_EXISTING_REGEXP ".*\.itm" ~override~

    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof
    READ_ASCII 0x22 wpn_appearance (2)

	PATCH_IF wpn_cat == 20  AND (wpn_prof == 90 OR wpn_prof == 94 OR (wpn_prof == 95 AND "%wpn_appearance%" STRING_COMPARE_CASE "sc" = 0)) BEGIN // long swords, katanas or scimitars
        LPF a7_auto_apply_spl_effect
            STR_VAR
                function_name = ~ADD_ITEM_EQEFFECT~
                effect_codes = ~op=263,tg=1,p1=-1,tmg=2~
        END
    END

    PATCH_IF wpn_cat == 26  AND wpn_prof == 102 BEGIN // quarterstaves
        LPF a7_auto_apply_spl_effect
            STR_VAR
                function_name = ~ADD_ITEM_EQEFFECT~
                effect_codes = ~op=263,tg=1,p1=-2,tmg=2~
        END
    END

BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1125 DESIGNATED 1125 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "WANINJA.itm" ~override~
    WRITE_LONG 0x1e 1074057600 // usability opened
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1130 DESIGNATED 1130 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
COPY "%MOD_FOLDER%/eff/ZSTW_DG6.EFF" ~override~

COPY_EXISTING ~DAGG14.ITM~ ~override~
    SAY IDENTIFIED_DESC @6000
    LPF ADD_ITEM_EFFECT
        INT_VAR
            type = 1
            timing = 1
            opcode = 12
            target = 2
            dicesize  = 4
            dicenumber = 1
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 12
            parameter2 = (1 << 16)
    END
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=27,tgt=1,p1=40,tmg=2~
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 2
            def_parameter2 = 4
            def_timing = 1
        STR_VAR
            def_resource = ~ZSTW_DG6~
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~t=1,op=177,p1=2;t=1,op=177,p1=123;t=1,op=177,p1=172;t=1,op=177,p1=138;t=1,op=177,p1=167;t=1,op=177,p1=135;t=1,op=177,p1=124~
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1140 DESIGNATED 1140 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~DAGG21.ITM~ ~override~
    SAY IDENTIFIED_DESC @6010
    SAY NAME2 @6011
    WRITE_LONG 0x60 5
    LPF ALTER_ITEM_HEADER
        INT_VAR
            header_type = 1
            damage_bonus = 5
            thac0_bonus = 5
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 20
            probability1 = 9
    END
BUT_ONLY

COPY_EXISTING ~DAGG22.ITM~ ~override~
    SAY IDENTIFIED_DESC @6013
    SAY NAME2 @6012
    WRITE_LONG 0x60 6
    LPF ALTER_ITEM_HEADER
        INT_VAR
            header_type = 1
            damage_bonus = 6
            thac0_bonus = 6
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 20
            probability1 = 14
    END
    SET fire = (8 << 16)
    SET electricity = (4 << 16)
     LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 2
            def_timing = 9
            def_dicesize = 8
            def_dicenumber = 1
            def_type = 1
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=12,p2=%fire%,pro1=93,pro2=89;op=12,p2=%electricity%,pro1=88,pro2=84~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1150 DESIGNATED 1150 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof

    PATCH_IF wpn_cat == 29  AND wpn_prof == 98 BEGIN // spears
        LPF ALTER_HEADER
            INT_VAR
                match_type = 1
                match_dicesize = 6
                match_dicenumber = 1
                dicesize = 8
                silent = 1
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1160 DESIGNATED 1160 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof

    PATCH_IF wpn_cat == 21  AND wpn_prof == 97 BEGIN // warhammers
        LPF ALTER_HEADER
            INT_VAR
                match_type = 1
                match_dicesize = 4
                match_dicenumber = 1
                dicesize = 5
                silent = 1
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1170 DESIGNATED 1170 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~LEAT19.ITM~ ~override~
    LPF DELETE_ITEM_EQEFFECT
        INT_VAR
            opcode_to_delete = 27 // not great
    END

    LPF DELETE_ITEM_EQEFFECT
        INT_VAR
            opcode_to_delete = 142 // not great
    END

    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes =~op=69;op=169,p2=59;op=169,p2=53;op=142,p2=90;op=101,p2=216;op=282,p1=1,p2=2;op=267,p1=41495;op=267,p1=40968;op=267,p1=40969;op=267,p1=40979;op=267,p1=41616;op=346,p1=4~
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1180 DESIGNATED 1180 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet bgee" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~RING36.ITM~ ~override~
    SAY IDENTIFIED_DESC @6030
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes =~op=292,p2=1~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1190 DESIGNATED 1190 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~RODS02.ITM~ ~override~
    WRITE_LONG 0x1e 0 // usable by anyone
    SAY IDENTIFIED_DESC @6040
BUT_ONLY

COPY_EXISTING ~rods02a.ITM~ ~override~
    WRITE_LONG 0x1e 0 // usable by anyone
    SAY IDENTIFIED_DESC @6040
BUT_ONLY

COPY_EXISTING ~RODMACE.ITM~ ~override~
    WRITE_LONG 0x60 3
    SAY NAME1 @6041
    SAY NAME2 @6041
    SAY UNIDENTIFIED_DESC @6044
    SAY IDENTIFIED_DESC @6044
    LPF ALTER_HEADER
        INT_VAR
            match_type = 1
            speed = 4
            damage = 4
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            header_type = 1
            check_headers = 1
            match_opcode = 24
            savebonus = 2
            duration = 12
    END
BUT_ONLY

COPY_EXISTING ~RODSWORD.ITM~ ~override~
    WRITE_LONG 0x60 3
    WRITE_SHORT 0x22 21318 // equipped appearance of flaming sword
    SAY NAME1 @6042
    SAY NAME2 @6042
    SAY UNIDENTIFIED_DESC @6045
    SAY IDENTIFIED_DESC @6045
    LPF ALTER_HEADER
        INT_VAR
            match_type = 1
            speed = 2
            damage = 3
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            header_type = 1
            check_headers = 1
            savebonus = 2
            duration = 6
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            match_opcode = 139
            check_headers = 1
            duration = 0
    END
    LPF DELETE_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 1
            match_opcode = 109
            multi_match = 1
    END
    SET fire = (8 << 16)
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 2
            def_timing = 1
            def_type = 1
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes =~op=12,dsize=1,dnum=4,p2=%fire%~
    END
BUT_ONLY

COPY_EXISTING ~RODSPEAR.ITM~ ~override~
    SAY NAME1 @6043
    SAY NAME2 @6043
    SAY UNIDENTIFIED_DESC @6046
    SAY IDENTIFIED_DESC @6046
    LPF ALTER_HEADER
        INT_VAR
            match_type = 1
            overhand = 25
            thrust = 75
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 12
            savebonus = 0
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
//BEGIN @1200 DESIGNATED 1200 GROUP @2
//REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only" FOR LATER, DELETING ITEMS IS HARD
/////////////////////////////////////////////////////////////////////////////////////////////////////

/*COPY_EXISTING ~SPER12.ITM~ ~override~
    LPF DELETE_EFFECT
        INT_VAR
            header = 4
    END
BUT_ONLY*/

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1210 DESIGNATED 1210 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING ~SW1H54.ITM~ ~override~
    SAY IDENTIFIED_DESC @6060
    WRITE_LONG 0x60 5
    LPF ALTER_HEADER
        INT_VAR
            damage = 3
            speed = 2
            to_hit = 3
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1220 DESIGNATED 1220 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SW1H33.ITM~ ~override~
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 67
            duration = 60
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 122
            duration = 60
    END
BUT_ONLY

COPY_EXISTING ~SW1H33C.ITM~ ~override~
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 67
            duration = 60
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 122
            duration = 60
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1230 DESIGNATED 1230 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SW1H59.ITM~ ~override~
    SAY IDENTIFIED_DESC @6100
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 216
            parameter1 = 2
            probability1 = 20
            probability2 = 34
    END
    /*SET tlk_index = RESOLVE_STR_REF (@6101)
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 139
        //    parameter1 = tlk_index // no point in inserting a String for level drain levels, other level drain effects will have no knowledge of this
            //parameter1 = 40968 // this is only true in vanilla BG2EE, but what of EET?
            probability1 = 21
            probability2 = 35
    END*/
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 141
            probability1 = 20
            probability2 = 34
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 0
            probability1 = 19
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 126
            probability1 = 19
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 154
            probability1 = 19
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 142
            probability1 = 19
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 174
            probability1 = 19
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1240 DESIGNATED 1240 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

COPY_EXISTING ~SW1H64.ITM~ ~override~
    SAY IDENTIFIED_DESC @6090

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END
    WRITE_LONG (offset_eff + 0x4) 3 // MASK_EVIL
BUT_ONLY

 COPY_EXISTING ~SW1H65.ITM~ ~override~
   SAY IDENTIFIED_DESC @6091

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END
    WRITE_LONG (offset_eff + 0x4) 3 // MASK_EVIL
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1241 DESIGNATED 1241 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SW1H65.ITM~ ~override~
    LPF ALTER_EFFECT
        INT_VAR
            header_type = 3
            header = 2
            match_opcode = 146
            parameter1 = 30
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1250 DESIGNATED 1250 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SW1H66.ITM~ ~override~
    SAY IDENTIFIED_DESC @6110
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 0
            parameter1 = 2
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
            def_resist_dispel = 2
            def_parameter1 = 5
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=0,p1=1,p2=14;op=27;op=28;op=29;op=30;op=31;op=86;op=87;op=88;op=89;op=166;op=173~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1260 DESIGNATED 1260 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SW1H67.ITM~ ~override~
    SAY IDENTIFIED_DESC @6120
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 12
            dicesize = 4
            dicenumber = 5
            parameter1 = 1
            savebonus = "-2"
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
            def_resist_dispel = 2
            def_parameter1 = 40
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=29~
    END
    SET electricity = (4 << 16)
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~t=1,op=12,tgt=2,tmg=9,p2=%electricity%,dsize=3,dnum=1~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1270 DESIGNATED 1270 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SW1H68.ITM~ ~override~
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 67
            duration = 60
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 122
            duration = 60
    END
BUT_ONLY

COPY_EXISTING ~SW1H68C.ITM~ ~override~
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 67
            duration = 60
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 122
            duration = 60
    END

BUT_ONLY

COPY_EXISTING ~SW1H69.ITM~ ~override~
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 67
            duration = 60
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 122
            duration = 60
    END
BUT_ONLY

COPY_EXISTING ~SW1H69C.ITM~ ~override~
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 67
            duration = 60
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 122
            duration = 60
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1280 DESIGNATED 1280 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

OUTER_SET both = 0

ACTION_IF MOD_IS_INSTALLED ~ZSTweaks.tp2~ ~1290~ BEGIN
    OUTER_SET both = 1
END

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

COPY_EXISTING ~SW2H10.ITM~ ~override~
    PATCH_IF both BEGIN
        SAY IDENTIFIED_DESC @6083
    END ELSE BEGIN
        SAY IDENTIFIED_DESC @6080
    END

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END
    SET offset_dmg_eff = offset_eff + (0x30 * 2) // opcode eff
    WRITE_LONG (offset_dmg_eff + 0x4) 3 // MASK_EVIL
BUT_ONLY

 COPY_EXISTING ~SW2H19.ITM~ ~override~
   PATCH_IF both BEGIN
        SAY IDENTIFIED_DESC @6085
    END ELSE BEGIN
        SAY IDENTIFIED_DESC @6081
    END
    LPF itm_first_offset_effect
        RET offset_eff = offset
    END
    SET offset_dmg_eff = offset_eff + (0x30 * 2) // opcode eff
    WRITE_LONG (offset_dmg_eff + 0x4) 3 // MASK_EVIL
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1290 DESIGNATED 1290 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

OUTER_SET both = 0
ACTION_IF MOD_IS_INSTALLED ~ZSTweaks.tp2~ ~1280~ THEN BEGIN
    OUTER_SET both = 1
END

COPY_EXISTING ~SW2H10.ITM~ ~override~
    PATCH_IF both BEGIN
        SAY IDENTIFIED_DESC @6083
    END ELSE BEGIN
        SAY IDENTIFIED_DESC @6082
    END

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END

    SET eff_number = SHORT_AT((LONG_AT 0x64) + 0x1e)
    FOR ( eff = 0; eff < eff_number; ++eff ) BEGIN
        PATCH_IF eff != 2 BEGIN // except third header, where the damage to evil is located
            WRITE_LONG (offset_eff + 0x24) 1 // save vs spell allowed
        END
        offset_eff += 0x30
    END
BUT_ONLY

COPY_EXISTING ~SW2H19.ITM~ ~override~
    PATCH_IF both BEGIN
        SAY IDENTIFIED_DESC @6085
    END ELSE BEGIN
        SAY IDENTIFIED_DESC @6084
    END

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END

    SET eff_number = SHORT_AT((LONG_AT 0x64) + 0x1e)
    FOR ( eff = 0; eff < eff_number; ++eff ) BEGIN
        PATCH_IF eff != 2 BEGIN // except third header, where the damage to evil is located
            WRITE_LONG (offset_eff + 0x24) 1 // save vs spell allowed
            WRITE_LONG (offset_eff + 0x28) "-2" // "at -2 for +6"
        END
        offset_eff += 0x30
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1300 DESIGNATED 1300 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~SW2H15.ITM~ ~override~
    WRITE_LONG 0x60 4
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1310 DESIGNATED 1310 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING ~WAFLAIL.ITM~ ~override~
    SAY IDENTIFIED_DESC @6130
    FOR ( opcode = 86; opcode <= 88; ++opcode ) BEGIN
        LPF ALTER_ITEM_EFFECT
            INT_VAR
                check_globals = 1
                match_opcode = opcode
                parameter1 = 10
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1311 DESIGNATED 1311 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE/BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
COPY ~ZSTweaks/eff/ZSTWBL01.EFF~ ~override~

COPY_EXISTING ~BLUN11.ITM~ ~override~
    SAY IDENTIFIED_DESC @6150
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~t=1,op=177,tgt=2,p1=1,p2=3,tmg=1,rd=2,res=ZSTWBL01~
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1312 DESIGNATED 1312 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
COPY ~ZSTweaks/eff/ZSTWBL02.EFF~ ~override~

COPY_EXISTING ~BLUN18.ITM~ ~override~
    SAY IDENTIFIED_DESC @6160
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWBL02~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1313 DESIGNATED 1313 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
COPY ~ZSTweaks/spl/other/ZSTWPAIN.SPL~ ~override~

COPY_EXISTING ~BLUN24.ITM~ ~override~
    SAY IDENTIFIED_DESC @6182
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~t=1,tgt=2,op=146,res=ZSTWPAIN,p2=1,tmg=1,rd=2~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1314 DESIGNATED 1314 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING ~WAMACE.ITM~ ~override~
    WRITE_LONG 0x60 3
    SAY NAME2 @6350
    SAY IDENTIFIED_DESC @6351
    LPF ALTER_HEADER
        INT_VAR
            match_damage = 3
            match_to_hit = 2
            match_speed = 5
            to_hit = 3
            speed = 4
            damage = 4
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1315 DESIGNATED 1315 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING ~WA2DAK.ITM~ ~override~
    WRITE_LONG 0x60 3
    SAY NAME2 @6330
    SAY IDENTIFIED_DESC @6331
    LPF ALTER_HEADER
        INT_VAR
            match_damage = 2
            match_to_hit = 2
            match_speed = 2
            to_hit = 3
            speed = 1
            damage = 3
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1316 DESIGNATED 1316 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY
    ~ZSTweaks/eff/ZSTWTHM1.EFF~ override
    ~ZSTweaks/eff/ZSTWTHM2.EFF~ override
    ~ZSTweaks/eff/ZSTWTHM3.EFF~ override

COPY_EXISTING ~WA2RING.ITM~ ~override~
    WRITE_LONG 0x1e 1611987392 // allows rangers to use it
    SAY IDENTIFIED_DESC @6340
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
            def_parameter1 = 4
            def_parameter2 = 5
            def_resist_dispel = 2
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=177,res=ZSTWTHM1;op=177,res=ZSTWTHM2;op=177,res=ZSTWTHM3~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1317 DESIGNATED 1317 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE/BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~CLCK12.ITM~ ~override~ // knave
    SAY IDENTIFIED_DESC @6140
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 0
            parameter2 = 12
            parameter1 = 2
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=36,p1=1;op=173,p1=50;~
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
            def_parameter1 = 5
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=275;op=276;op=277;op=59;op=90;op=91;op=92~
    END
BUT_ONLY

COPY_EXISTING ~CLCK13.ITM~ ~override~ // traveler
    SAY IDENTIFIED_DESC @6141
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 0
            parameter1 = 3
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 36
            new_opcode = 37
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=34,p1=1;op=89,p1=15;op=176,p1=4~
    END
BUT_ONLY

COPY_EXISTING ~CLCK14.ITM~ ~override~ // adventurer
    SAY IDENTIFIED_DESC @6142
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 0
            parameter2 = 0
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 35
            new_opcode = 325
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
            def_parameter1 = 10
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=37,p1=1;op=31,p1=20;op=30;op=29;op=28;op=27~
    END
BUT_ONLY

COPY_EXISTING ~CLCK09.ITM~ ~override~ // cold resist clck
    SAY IDENTIFIED_DESC @6144
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 28
            parameter1 = 40
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=346,p1=1,spec=6;op=332,p1=7,p2=2~
    END
BUT_ONLY

COPY_EXISTING ~CLCK10.ITM~ ~override~ // fire resist clck
    SAY IDENTIFIED_DESC @6145
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 30
            parameter1 = 40
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=346,p1=1,spec=6;op=332,p1=7,p2=1~
    END
BUT_ONLY

COPY_EXISTING ~bdrobe05.ITM~ ~override~ // robe of flames
    SAY IDENTIFIED_DESC @6146
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 30
            parameter1 = 50
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=346,p1=1,spec=6~
    END
BUT_ONLY

COPY_EXISTING ~CLCK11.ITM~ ~override~ // electric resist clck
    SAY IDENTIFIED_DESC @6143
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 29
            parameter1 = 40
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=346,p1=1,spec=6;op=332,p1=7,p2=3~
    END
BUT_ONLY

COPY_EXISTING_REGEXP ~CLCK1[567]\.ITM~ ~override~ // archmage robes
    PATCH_IF "%SOURCE_RES%" STR_EQ ~CLCK15~ BEGIN
        SAY IDENTIFIED_DESC @6147
    END ELSE BEGIN
        PATCH_IF "%SOURCE_RES%" STR_EQ ~CLCK16~ BEGIN
            SAY IDENTIFIED_DESC @6148
        END ELSE BEGIN
            SAY IDENTIFIED_DESC @6149
        END
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 166
            parameter1 = 10
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 37
            parameter1 = 2
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
            def_target = 1
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=31,p1=25;op=189,p1=1;op=0,p1=1,p2=0~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1318 DESIGNATED 1318 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~SW2H12.ITM~ ~override~
    SAY IDENTIFIED_DESC @6170
    LPF itm_first_offset_effect
        RET offset_eff = offset
    END // opcode eff
    WRITE_LONG (offset_eff + 0x4) 3 // MASK_EVIL
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1319 DESIGNATED 1319 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

COPY_EXISTING ~OHDHSWD.ITM~ ~override~
    SAY IDENTIFIED_DESC @6190
    LPF itm_first_offset_effect
        RET offset_eff = offset
    END // opcode eff
    WRITE_LONG (offset_eff + 0x4) 3 // MASK_EVIL
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
//BEGIN @1320 DESIGNATED 1320 GROUP @2 flail of ages, not implemented yet
/////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1321 DESIGNATED 1321 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY
    ~ZSTweaks/eff/ZSTWBL03.EFF~ ~override~
    ~ZSTweaks/eff/ZSTWBL04.EFF~ ~override~

COPY_EXISTING ~BLUN23.ITM~ ~override~
    SAY NAME2 @6360
    SAY IDENTIFIED_DESC @6361

    LPF ALTER_HEADER
        INT_VAR
            type = 1
            match_damage = 2
            match_to_hit = 2
            damage = 3
            to_hit = 3
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 344
            special = 5
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWBL03~
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWBL04~
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 2
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~t=1,op=177,tgt=2,tmg=1,rd=2,p1=175,p2=4,res=ZSTWBL04~ // spectral undead extra bonus
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1330 DESIGNATED 1330 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~BOW20.ITM~ ~override~
    SAY IDENTIFIED_DESC @6180
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 28
            parameter1 = 15
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 30
            parameter1 = 15
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 84
            parameter1 = 15
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 85
            parameter1 = 15
    END
    SET cold = (2 << 16)
    SET fire = (8 << 16)
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 1
            def_target = 2
            def_parameter1 = 1
            def_type = 4
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=12,p2=%cold%;op=12,p2=%fire%~
    END
BUT_ONLY

COPY_EXISTING ~BOW21.ITM~ ~override~
    SAY IDENTIFIED_DESC @6181
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 28
            parameter1 = 30
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 30
            parameter1 = 30
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 84
            parameter1 = 30
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 85
            parameter1 = 30
    END
    SET cold = (2 << 16)
    SET fire = (8 << 16)
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 1
            def_target = 2
            def_parameter1 = 2
            def_type = 4
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=12,p2=%cold%;op=12,p2=%fire%~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1340 DESIGNATED 1340 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////
// RACES
// ankheg 101
// carrion crawler 104
// chimera 177
// ettercap 107
// gibberling 109
// hook horror 167
// otyugh 127
// spider 116
// troll 129
// umberhulk 130
// wyvern 118
// basilisk 102

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY
    ~ZSTweaks/eff/ZSTWMI01.EFF~
    ~ZSTweaks/eff/ZSTWMI02.EFF~

COPY_EXISTING ~BOW22.ITM~ ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 1
            def_target = 2
            def_parameter2 = 4
            def_type = 4
        STR_VAR
            def_resource = ~ZSTWMI01~
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=177,p1=2,p2=3;op=177,p1=101;op=177,p1=104;op=177,p1=177;op=177,p1=107;op=177,p1=109;op=177,p1=167;op=177,p1=127;op=177,p1=116;op=177,p1=129;op=177,p1=130;op=177,p1=118;op=177,p1=102~
    END
BUT_ONLY

COPY_EXISTING ~BOW23.ITM~ ~override~
    LPF ALTER_HEADER
        INT_VAR
            type = 4
            damage = 1
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 126
            parameter1 = 5
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_timing = 1
            def_target = 2
            def_parameter2 = 4
            def_type = 4
        STR_VAR
            def_resource = ~ZSTWMI02~
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=177,p1=2,p2=3;op=177,p1=101;op=177,p1=104;op=177,p1=177;op=177,p1=107;op=177,p1=109;op=177,p1=167;op=177,p1=127;op=177,p1=116;op=177,p1=129;op=177,p1=130;op=177,p1=118;op=177,p1=102~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1341 DESIGNATED 1341 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET only"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING ~SW1H70.ITM~ ~override~
    SAY IDENTIFIED_DESC @6070
    SAY NAME1 @6072
    SAY NAME2 @6072
    WRITE_LONG 0x60 4
    LPF ALTER_HEADER
        INT_VAR
            match_damage = 3
            damage = 4
            match_to_hit = 3
            to_hit = 4
    END
BUT_ONLY
COPY_EXISTING ~SW1H71.ITM~ ~override~
    SAY IDENTIFIED_DESC @6071
    SAY NAME1 @6073
    SAY NAME2 @6073
    WRITE_LONG 0x60 5
    LPF ALTER_HEADER
        INT_VAR
            match_damage = 4
            damage = 5
            match_to_hit = 4
            to_hit = 5
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1350 DESIGNATED 1350 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This component was written only for BGEE/BG2EE/EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_correct_animations.tph~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_BYTE  0x31 wpn_prof
    READ_ASCII 0x22 wpn_appearance (2)


	PATCH_IF wpn_prof = 95 AND ("%wpn_appearance%" STRING_COMPARE_CASE "ss" = 0 OR "%wpn_appearance%" STRING_COMPARE_CASE "s1" = 0) BEGIN // wakizashis and ninjatos
        LPF ALTER_HEADER
            INT_VAR
                silent = 1
                match_type = 1
                match_dicesize = 8
                match_dicenumber = 1
                dicenumber = 2
                dicesize = 4
        END

        FOR ( current_sp = 4; current_sp > 0; --current_sp ) BEGIN // decrease ninja-tos speed by 1
            LPF ALTER_HEADER
                INT_VAR
                    silent = 1
                    match_type = 1
                    match_speed = current_sp
                    speed = current_sp - 1
            END
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1351 DESIGNATED 1352 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This component was written only for BGEE/BG2EE/EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_correct_animations.tph~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_BYTE  0x31 wpn_prof
    READ_ASCII 0x22 wpn_appearance (2)

	PATCH_IF wpn_prof = 95 AND "%wpn_appearance%" STRING_COMPARE_CASE "ss" = 0 BEGIN // wakizashis
        LPF ALTER_HEADER
            INT_VAR
                silent = 1
                match_type = 1
                damage_type = 7 // piercing or slashing
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1360 DESIGNATED 1360 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING ~xbow04.itm~ ~override~
	READ_LONG 0x08 light_xbow_strref // get the strref for "light crossbow"
BUT_ONLY

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof
    READ_SHORT 0x26 min_str
    READ_LONG 0x08 name_strref

    PATCH_IF wpn_cat = 27  AND wpn_prof = 103 AND (name_strref = %light_xbow_strref% OR min_str <= 8) BEGIN // light crossbows (crossbows, that are called "Light crossbow" in the general name or failing that, that need at least 8 STR )
       // PATCH_PRINT "found"
        LPF a7_auto_apply_spl_effect
            STR_VAR
                function_name = ~ADD_ITEM_EQEFFECT~
                effect_codes = ~op=1,tgt=1,p1=6,p2=0,tmg=2~
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1370 DESIGNATED 1370 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof
    READ_SHORT 0x26 min_str

    PATCH_IF wpn_cat = 20  AND wpn_prof = 94 BEGIN // katanas
        LPF ALTER_HEADER
            STR_VAR
                match_type = 1
                match_dicesize = 10
                match_dicenumber = 1
                dicesize = 5
                dicenumber = 2
        END
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1380 DESIGNATED 1380 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "NPSW05.ITM" ~override~
    WRITE_LONG 0x60 3
    SAY IDENTIFIED_DESC @6050
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=1,tgt=1,p1=6,p2=0,tmg=2~
    END
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 1
            match_opcode = 25
            parameter1 = 2
            savebonus = "-1"
    END
BUT_ONLY

COPY_EXISTING "NPSW06.ITM" ~override~
    WRITE_LONG 0x60 3
    SAY IDENTIFIED_DESC @6051
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=1,tgt=1,p1=6,p2=0,tmg=2~
    END
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~t=1,op=33,tgt=2,p1=-1,dur=12,rd=2~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1390 DESIGNATED 1390 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

COPY_EXISTING ~STAFF11.ITM~ ~override~
    SAY IDENTIFIED_DESC @6400

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END

    SET eff_number = SHORT_AT((LONG_AT 0x64) + 0x1e)
    FOR ( eff = 0; eff < eff_number; ++eff ) BEGIN
        WRITE_LONG (offset_eff + 0x24) 1 // save vs spell allowed
        WRITE_LONG (offset_eff + 0x28) "-2" // at
        offset_eff += 0x30
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1400 DESIGNATED 1400 GROUP @2
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof

	PATCH_IF wpn_cat == 20  AND wpn_prof == 89 BEGIN // bastard swords
        LPF ALTER_HEADER
            INT_VAR
                silent = 1
                match_type = 1
                match_dicesize = 4
                match_dicenumber = 2
                dicenumber = 1
                dicesize = 8
        END
        FOR ( current_dmg = 6; current_dmg >= 0; current_dmg -= 1 ) BEGIN
            LPF ALTER_HEADER
                INT_VAR
                    silent = 1
                    match_type = 1
                    match_damage = current_dmg
                    damage = current_dmg + 1
            END
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1410 DESIGNATED 1410 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

OUTER_SET both = 0

ACTION_IF MOD_IS_INSTALLED ~ZSTweaks.tp2~ ~1420~ THEN BEGIN
    OUTER_SET both = 1
END

COPY_EXISTING ~ohreaver.ITM~ ~override~
    PATCH_IF both BEGIN
        SAY IDENTIFIED_DESC @6282
    END ELSE BEGIN
        SAY IDENTIFIED_DESC @6281
    END

    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            probability1 = 100
    END

    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            savingthrow = 1
    END

    LPF itm_first_offset_effect
        RET offset_eff = offset
    END
    SET offset_dmg_eff = offset_eff + (0x30 * 8) // opcode eff against good
    WRITE_LONG (offset_dmg_eff + 0x24) 0 // no save
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1420 DESIGNATED 1420 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE/EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

OUTER_SET both = 0

ACTION_IF MOD_IS_INSTALLED ~ZSTweaks.tp2~ ~1410~ THEN BEGIN
    OUTER_SET both = 1
END

COPY_EXISTING "ohreaver.ITM" ~override~
    PATCH_IF both BEGIN
        SAY IDENTIFIED_DESC @6282
    END ELSE BEGIN
        SAY IDENTIFIED_DESC @6280
    END
    PATCH_IF MOD_IS_INSTALLED ~ZSTweaks.tp2~ ~1430~ THEN BEGIN
        LPF ALTER_HEADER
            INT_VAR
                match_type = 1
                match_dicesize = 9
                match_dicenumber = 1
                match_damage = 6
                dicesize = 6
                dicenumber = 2
                damage = 5
        END
    END ELSE BEGIN
        LPF ALTER_HEADER
            INT_VAR
                match_type = 1
                match_dicesize = 10
                dicesize = 12
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1430 DESIGNATED 1430 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This component is only compatible with BGEE/BG2EE/EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof

    PATCH_IF wpn_cat = 20  AND wpn_prof = 93 BEGIN // two-handed swords
        LPF ALTER_HEADER
            STR_VAR
                silent = 1
                match_type = 1
                match_dicesize = 12
                match_dicenumber = 1
                dicenumber = 2
                dicesize = 6
        END
        FOR ( current_dmg = 6; current_dmg >= 0; current_dmg -= 1 ) BEGIN
            LPF ALTER_HEADER
                INT_VAR
                    silent = 1
                    match_type = 1
                    match_dicesize = 10
                    match_dicenumber = 1
                    match_damage = current_dmg
                    dicesize = 9
                    damage = current_dmg + 1
            END
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1440 DESIGNATED 1440 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////
//complete later
INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY ~ZSTweaks/spl/daggers_default~ ~override~

ADD_PROJECTILE ~ZSTweaks/pro/ZSTW_IND.PRO~

COPY_EXISTING_REGEXP "ZSTWDP08.spl" ~override~ // spells to insert projectiles to (critical dagger effect)
    LPF ALTER_HEADER
        INT_VAR
            match_type = 1
            projectile = "%ZSTW_IND%"
    END
BUT_ONLY

COPY_EXISTING_REGEXP "ZSTWDP1[02468]\.spl" ~override~ // spells to insert projectiles to (throwing daggers and darts)
    LPF ALTER_HEADER
        INT_VAR
            match_type = 1
            projectile = "%ZSTW_IND%"
    END
BUT_ONLY

COPY_EXISTING_REGEXP "ZSTWDP20.spl" ~override~ // spells to insert projectiles to (critical dagger effect)
    LPF ALTER_HEADER
        INT_VAR
            match_type = 1
            projectile = "%ZSTW_IND%"
    END
BUT_ONLY

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof
    READ_SHORT 0x60 ench

	PATCH_IF wpn_cat == 16  AND wpn_prof == 96 BEGIN // daggers
        LPF ALTER_HEADER
            INT_VAR
                silent = 1
                match_type = 1
                speed = 0
        END
        FOR ( current_th = 6; current_th >= 0; current_th -= 1 ) BEGIN
            LPF ALTER_HEADER
                INT_VAR
                    silent = 1
                    match_type = 1
                    match_to_hit = current_th
                    to_hit = current_th + 1
            END
        END
        LPF a7_auto_apply_spl_effect
            STR_VAR
                function_name = ~ADD_ITEM_EQEFFECT~
                effect_codes = ~t=1,op=301,tgt=1,p1=1,p2=1,tmg=2~
        END
        PATCH_IF ench = 0 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP08~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP10~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP12~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP14~
            END
        END

        PATCH_IF ench = 4 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP16~
            END
        END

        PATCH_IF ench = 5 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP18~
            END
        END

        PATCH_IF ench = 6 BEGIN
            LPF a7_auto_apply_spl_effect
                STR_VAR
                    function_name = ~ADD_ITEM_EQEFFECT~
                    effect_codes = ~t=1,op=341,tgt=1,p2=1,tmg=2,res=ZSTWDP20~
            END
        END
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1450 DESIGNATED 1450 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This mod was written for BGEE and BG2EE"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_itm_dmg_by_class.tpa~
INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_correct_animations.tph~

COPY ~ZSTweaks/spl/finesse~ ~override~

ADD_PROJECTILE ~ZSTweaks/pro/ZSTW_INP.PRO~
ADD_PROJECTILE ~ZSTweaks/pro/ZSTW_IND.PRO~

COPY_EXISTING_REGEXP "ZSTW[ABS][0-6]\.spl" ~override~ // spells to insert projectiles to (for arrows, bolts and sling bullets)
    LPF ALTER_HEADER
        INT_VAR
            match_type = 2
            projectile = "%ZSTW_INP%"
    END
BUT_ONLY

COPY_EXISTING_REGEXP "ZSTW[TZ][0-6]\.spl" ~override~ // spells to insert projectiles to (throwing daggers and darts)
    LPF ALTER_HEADER
        INT_VAR
            match_type = 2
            projectile = "%ZSTW_IND%"
    END
BUT_ONLY

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    READ_SHORT 0x1c wpn_cat
    READ_BYTE  0x31 wpn_prof
    READ_SHORT 0x60 ench
    READ_SHORT 0x22 wpn_appearance

	PATCH_IF wpn_cat == 16  AND wpn_prof == 96 BEGIN // daggers
        PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD0~
            END
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWZ0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD1~
            END
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWZ1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD2~
            END
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWZ2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD3~
            END
             LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWZ3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD4~
            END
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWZ4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD5~
            END
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWZ5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD6~
            END
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWD6~
            END
        END
    END // end daggers

    PATCH_IF wpn_cat == 14 BEGIN // slings/bullets
        PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWS6~
            END
        END
    END // end slings/bullets

    PATCH_IF wpn_cat == 5 BEGIN // arrows
     //   PATCH_IF ench = 0 BEGIN // will assume vanilla BG2 values for arrow dmg, probably more balanced anyway
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 44
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWA0~
            END
    END // end arrows

    PATCH_IF wpn_cat == 31 BEGIN // bolts
      //  PATCH_IF ench = 0 BEGIN // will assume vanilla BG2 values for arrow dmg, probably more balanced anyway
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWB0~
            END
    END // end bolts

    PATCH_IF wpn_cat = 24  AND wpn_prof == 106 BEGIN // darts
        PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 2
                    probability1 = 59
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWT6~
            END
        END
    END // end darts

    PATCH_IF wpn_cat = 26  AND wpn_prof == 102 BEGIN // staves
        PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ6~
            END
        END
    END // end staves

    PATCH_IF wpn_cat = 20  AND (wpn_prof = 90 OR (wpn_prof = 95 AND "%wpn_appearance%" STRING_COMPARE_CASE "sc" = 0)) BEGIN // long swords and scimitars
         PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 9
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL6~
            END
        END
    END // end long swords and scimitars

    PATCH_IF wpn_cat = 20  AND wpn_prof = 95 AND "%wpn_appearance%" STRING_COMPARE_CASE "s1" = 0 BEGIN // ninja-tos
         PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWL6~
            END
        END
    END // end ninja-tos

    PATCH_IF wpn_cat = 20  AND wpn_prof = 94 BEGIN // katanas
         PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 14
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWK6~
            END
        END
    END // end katanas

    PATCH_IF wpn_cat = 19  AND wpn_prof = 95 AND "%wpn_appearance%" STRING_COMPARE_CASE "ss" = 0 BEGIN // wakizashis
         PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 24
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWW6~
            END
        END
    END // end wakizashis

    PATCH_IF wpn_cat = 19  AND wpn_prof = 91 BEGIN // short swords
         PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWY6~
            END
        END
    END // end short swords

    PATCH_IF wpn_cat = 17  AND wpn_prof = 115 BEGIN // clubs
         PATCH_IF ench = 0 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ0~
            END
        END
        PATCH_IF ench = 1 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ1~
            END
        END
        PATCH_IF ench = 2 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ2~
            END
        END
        PATCH_IF ench = 3 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ3~
            END
        END
        PATCH_IF ench = 4 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ4~
            END
        END
        PATCH_IF ench = 5 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ5~
            END
        END
        PATCH_IF ench = 6 BEGIN
            LPF weapon_damage_by_class
                INT_VAR
                    type = 1
                    probability1 = 34
                STR_VAR
                    class = ~THIEF~
                    spell = ~ZSTWQ6~
            END
        END
    END // end clubs
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1460 DESIGNATED 1460 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "SPER10.ITM" ~override~
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_type = 1
            def_target = 2
            def_resist_dispel = 2
            def_duration = 6
            def_savebonus = "-2"
            def_savetype = 4
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=25,p1=2,p2=2;op=142,p2=6~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1470 DESIGNATED 1470 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "SW1H35.ITM" ~override~
    SAY IDENTIFIED_DESC @6410
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            match_opcode = 17
            probability1 = 49
    END
    LPF ADD_ITEM_EFFECT
        INT_VAR
            target = 1
            timing = 1
            insert_point = 0
            type = 1
            opcode = 17
            probability1 = 69
            probability2 = 50
            power = 1
            parameter1 = 2
    END
    LPF ADD_ITEM_EFFECT
        INT_VAR
            target = 1
            timing = 1
            insert_point = 0
            type = 1
            opcode = 17
            probability1 = 84
            probability2 = 70
            power = 1
            parameter1 = 3
    END
    LPF ADD_ITEM_EFFECT
        INT_VAR
            target = 1
            timing = 1
            insert_point = 0
            type = 1
            opcode = 17
            probability1 = 94
            probability2 = 85
            power = 1
            parameter1 = 4
    END
    LPF ADD_ITEM_EFFECT
        INT_VAR
            target = 1
            timing = 1
            insert_point = 0
            type = 1
            opcode = 17
            probability1 = 100
            probability2 = 95
            power = 1
            parameter1 = 5
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1480 DESIGNATED 1480 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "NPSW02.ITM" ~override~
    SAY IDENTIFIED_DESC @6270
    LPF ALTER_HEADER
        INT_VAR
            type = 1
            match_speed = 3
            speed = 1
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=301,p1=2,p2=1;op=233,p1=2,p2=94~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1490 DESIGNATED 1490 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "NEBDAG.ITM" ~override~
    SAY IDENTIFIED_DESC @6230
    WRITE_ASCII 0x10 ~~ #8
    LPF ALTER_HEADER
        INT_VAR
            type = 1
            charges = 0
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1500 DESIGNATED 1500 GROUP @2 // mazzy component
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This component is only compatible with BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "NPSW01.ITM" ~override~
    SAY NAME2 @6260
    SAY IDENTIFIED_DESC @6261
    WRITE_LONG 0x60 4
    PATCH_IF MOD_IS_INSTALLED ~ZSTweaks.tp2~ ~1450~  THEN BEGIN
        PATCH_PRINT "Attempting modification of Mazzy's weapons for rogues"
        LPF ALTER_EFFECT
            INT_VAR
                check_globals = 0
                header_type = 1
                verbose = 1
            STR_VAR
                match_resource = ~ZSTWY2~
                resource = ~ZSTWY3~
        END
    END
    LPF ALTER_HEADER
        INT_VAR
            type = 1
            match_damage = 2
            match_to_hit = 2
            damage = 3
            to_hit = 4
            speed = 0
    END
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=1,tgt=1,p1=6,tmg=2,rd=2~
    END
BUT_ONLY

COPY_EXISTING "NPBOW.ITM" ~override~
    SAY NAME2 @6262
    SAY IDENTIFIED_DESC @6263
    WRITE_LONG 0x60 3
    LPF ALTER_HEADER
        INT_VAR
            type = 4
            damage = 1
            match_to_hit = 2
            to_hit = 3
    END
    LPF a7_auto_apply_spl_effect
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=1,tgt=1,p1=6,tmg=2,rd=2~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1510 DESIGNATED 1510 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "NPSHLD.ITM" ~override~
    SAY IDENTIFIED_DESC @6250
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 0
            parameter1 = 3
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1520 DESIGNATED 1520 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "NPSW03.ITM" ~override~
    SAY IDENTIFIED_DESC @6230
    WRITE_LONG 0x60 3
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1530 DESIGNATED 1530 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~

COPY_EXISTING_REGEXP "DAGG1[12]\.ITM" ~override~
    LPF ALTER_HEADER
        INT_VAR
            dicenumber = 1
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1540 DESIGNATED 1540 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
COPY ~ZSTweaks/eff/ZSTWWAVE.EFF~ ~override~

COPY_EXISTING "HALB09.ITM" ~override~
    SAY IDENTIFIED_DESC @6420
    SET cold = (2 << 16)
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_type = 1
            def_target = 2
            def_timing = 9
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=12,p1=3,p2=%cold%;op=177,p1=142,p2=4,res=ZSTWWAVE~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1550 DESIGNATED 1550 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~
INCLUDE ~ZSTweaks/libs/zs_alter_header.tpa~
COPY ~ZSTweaks/spl/other/ZSTWDRZB.SPL~ ~override~

COPY_EXISTING "SW1H15.ITM" ~override~
    SAY IDENTIFIED_DESC @6490
    SET cold = (2 << 16)
    WRITE_LONG 0x60 5 // ench
    WRITE_LONG 0x18 (LONG_AT 0x18) + 2**8 // silver
    LPF ALTER_HEADER
        INT_VAR
            type = 1
            to_hit = 5
    END
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_type = 1
            def_target = 2
            def_timing = 9
        STR_VAR
            function_name = ~ADD_ITEM_EFFECT~
            effect_codes = ~op=12,p2=%cold%,dnum=1,dsize=3;op=326,p2=3,res=ZSTWDRZB~
    END
BUT_ONLY

COPY_EXISTING "SW1H16.ITM" ~override~
    SAY IDENTIFIED_DESC @6500
    WRITE_LONG 0x60 5 // already considered +5, adding it just in case
    LPF ALTER_HEADER
        INT_VAR
            type = 1
            to_hit = 5
    END
    SET ac_except_crushing = 2**1 + 2**2 + 2**3
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=0,p1=2,p2=%ac_except_crushing%;op=37,p1=1;op=86,p1=8;op=87,p1=8;op=88,p1=8;op=89,p1=8~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1560 DESIGNATED 1560 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "bdbelt02.ITM" ~override~
    SAY IDENTIFIED_DESC @6510
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=332,p1=10,p2=8~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1570 DESIGNATED 1570 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "ohreyeb.ITM" ~override~
    SAY IDENTIFIED_DESC @6520
BUT_ONLY

COPY_EXISTING "ohreyeb1.SPL" ~override~
    LPF ALTER_EFFECT
        INT_VAR
            check_globals = 0
            header_type = 1
            match_savingthrow = 1
            savebonus = "-2"
    END
BUT_ONLY

COPY_EXISTING "ohreyeb2.SPL" ~override~
    LPF ALTER_EFFECT
        INT_VAR
            check_globals = 0
            header_type = 1
            match_savingthrow = 1
            savebonus = "-1"
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1600 DESIGNATED 1600 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "ohntank.ITM" ~override~
    SAY UNIDENTIFIED_DESC @6450
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_headers = 1
            header_type = 3
            match_opcode = 17
            dicesize = 0
            dicenumber = 0
            parameter1 = 27
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1610 DESIGNATED 1610 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_patch_spells.tpa~

COPY_EXISTING "ohnrobe2.ITM" ~override~
    SAY IDENTIFIED_DESC @6530
    LPF a7_auto_apply_spl_effect
        INT_VAR
            def_target = 1
            def_timing = 2
            def_parameter1 = 5
        STR_VAR
            function_name = ~ADD_ITEM_EQEFFECT~
            effect_codes = ~op=332,p2=1;op=332,p2=2;op=332,p2=3;op=332,p2=4;op=346,p1=2,spec=6~
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1620 DESIGNATED 1620 GROUP @2
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "ohnhelm1.ITM" ~override~
    SAY IDENTIFIED_DESC @6460
    LPF ALTER_ITEM_EFFECT
        INT_VAR
            check_globals = 1
            match_opcode = 281
            parameter1 = 25
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @1650 DESIGNATED 1650 GROUP @2
REQUIRE_PREDICATE GAME_IS "bgee bg2ee eet" "This component was written for BGEE, BG2EE and EET"
//////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING_REGEXP ".*\.itm" ~override~
    PATCH_IF (SHORT_AT 0x1c) = 2 BEGIN // armor
        READ_ASCII 0x22 armor_appearance (2)
        PATCH_IF "%armor_appearance%" STRING_COMPARE_CASE "2w" = 0 BEGIN // apperance of simple robes
            WRITE_ASCII 0x22 "3W" #2
        END
    END
BUT_ONLY

////////////////// CLASS AND KIT-RELATED TWEAKS \\\\\\\\\\\\\\\\\\\\\\\\\\

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2100 DESIGNATED 2100 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~
COPY
    ~ZSTweaks/eff/ZSTWF06.EFF~ ~override~
    ~ZSTweaks/eff/ZSTWF08.EFF~ ~override~
    ~ZSTweaks/eff/ZSTWF10.EFF~ ~override~
    ~ZSTweaks/eff/ZSTWF12.EFF~ ~override~
    ~ZSTweaks/eff/ZSTWF14.EFF~ ~override~

COPY_EXISTING "SPCL236.SPL" ~override~
    LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = 1
            zs_min_level_for_copy = 12
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 6
            match_opcode = 12
            dicenumber = 6
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 1
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWF06~
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 2
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWF08~
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 3
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWF10~
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 4
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWF12~
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 5
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWF14~
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = 6
            match_opcode = 177
        STR_VAR
            resource = ~ZSTWF16~
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2110 DESIGNATED 2110 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "SPCL239a.eff" ~override~
    WRITE_LONG 0x1c 0 // damage
    WRITE_LONG 0x3c 6 // dice size
    WRITE_LONG 0x38 3 // dice number
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2120 DESIGNATED 2120 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "SPCL908.SPL" ~override~
    SAY UNIDENTIFIED_DESC @6220
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            check_headers = 1
            savebonus = "-2"
            match_opcode = 142
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            check_headers = 1
            savebonus = "-2"
            match_opcode = 24
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            check_headers = 1
            savebonus = "-2"
            match_opcode = 141
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            check_headers = 1
            savebonus = "-2"
            match_opcode = 174
    END
BUT_ONLY


//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2130 DESIGNATED 2130 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "SPCL910B.SPL" ~override~
    SET piercing = (16 << 16)
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header_type = 1
            check_headers = 1
            match_opcode = 12
            parameter2 = piercing
    END
BUT_ONLY

//////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2140 DESIGNATED 2140 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING "SPCL911.SPL" ~override~
    SAY UNIDENTIFIED_DESC @6300
BUT_ONLY

COPY_EXISTING "SPCL911B.SPL" ~override~
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header_type = 1
            check_headers = 1
            match_opcode = 12
            dicenumber = 15
    END
BUT_ONLY

/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2150 DESIGNATED 2150 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee eet" "This mod was written for BG2EE and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

COPY_EXISTING_REGEXP "SPCL90[47]\.SPL" ~override~
    WRITE_BYTE 0x27 0
BUT_ONLY

COPY_EXISTING_REGEXP "SPCL91[3467]\.SPL" ~override~
    WRITE_BYTE 0x27 0
BUT_ONLY


/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2160 DESIGNATED 2160 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~
INCLUDE ~ZSTweaks/libs/zs_offsets.tpa~

COPY
    ~ZSTweaks/eff/ZSTWM01.EFF~ ~override~
    ~ZSTweaks/eff/ZSTWM02.EFF~ ~override~

COPY_EXISTING "SPCL820.SPL" ~override~
    SAY UNIDENTIFIED_DESC @6310
    SET abilities_per_header = SHORT_AT( (LONG_AT 0x64) + 0x1e)

    LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = 1
            zs_min_level_for_copy = 18
    END

     LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = 1
            zs_min_level_for_copy = 26
    END

    LPF spl_first_offset_effect
        RET spl_eff_offset = offset
    END

    SET offset_eff = spl_eff_offset + (0x30 * 7)
    WRITE_ASCII (offset_eff + 0x14) ~ZSTWM01~ #8
    SET offset_eff = spl_eff_offset + (0x30 * 14)
    WRITE_ASCII (offset_eff + 0x14) ~ZSTWM02~ #8
BUT_ONLY

/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2170 DESIGNATED 2170 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_rogue_thac0.tpa~
LAF generate_rogue_thac0
    STR_VAR
        class1 = ~thief~
        class2 = ~mage_thief~
END

/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2180 DESIGNATED 2180 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_rogue_thac0.tpa~

LAF generate_rogue_thac0
    STR_VAR
        class1 = ~bard~
END

/////////////////////////////////////////////////////////////////////////////////////////////////////
BEGIN @2190 DESIGNATED 2190 GROUP @3
REQUIRE_PREDICATE GAME_IS "bg2ee bgee eet" "This mod was written for BGEE, BG2EE, and EET"
/////////////////////////////////////////////////////////////////////////////////////////////////////

INCLUDE ~ZSTweaks/libs/zs_add_spell_header.tpa~

COPY_EXISTING ~SPCL423.SPL~ ~override~
    SAY UNIDENTIFIED_DESC @6440
BUT_ONLY

COPY_EXISTING ~BDPWEAPN.SPL~ ~override~
    READ_SHORT 0x68 ability_size
    LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = ability_size
            zs_min_level_for_copy = 17
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = ability_size + 1
            match_opcode = 12
            parameter1 = 8
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = ability_size + 1
            match_opcode = 25
            savebonus = "-3"
            duration = 27
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = ability_size + 1
            match_opcode = 142
            savebonus = "-3"
            duration = 27
    END
    LPF ADD_SPELL_HEADER
        INT_VAR
            copy_header = ability_size
            zs_min_level_for_copy = 21
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = ability_size + 2
            match_opcode = 12
            parameter1 = 10
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = ability_size + 2
            match_opcode = 25
            savebonus = "-4"
            duration = 30
    END
    LPF ALTER_SPELL_EFFECT
        INT_VAR
            header = ability_size + 2
            match_opcode = 142
            savebonus = "-4"
            duration = 30
    END
BUT_ONLY


/////////////////////////////////////////////////////////////////////////////////////////////////////
